# better locality and typing
# more duplication in the case that templates are re-used across nodes or relationships
pattern: "https://raw.githubusercontent.com/finos/architecture-as-code/main/calm/domains-example/pattern/secure-service-pattern.json"
global:
  properties:  # not sure about this. should this be a global constant that applies to all templates, or is this about definining something per-template to reduce duplication?
    appName: $.nodes['application'].name
    databaseName: $.nodes['database'].name
nodes:
  - unique-id: "load-balancer"
    templates:
      - filename: service.yaml
        properties:
          port: $.interfaces[1].port
          targetPort: $.interfaces[1].port
          appName: $.name
  - unique-id: "application"
    templates:
      - filename: application-deployment.yaml
        properties:
          image: $.interfaces[0].image # jsonpaths would probably use the name rather than the number
          port: $.interfaces[1].port
  - unique-id: "database"
    templates:
      - filename: database-deployment.yaml
        properties:
          image: $.interfaces[0].image # jsonpaths would probably use the name rather than the number
          port: $.interfaces[1].port
          persistence: $.persistence
          appName: $.name
relationships: 
  - unique-id: "application-database"
    templates:
      - filename: ingress.yaml
        properties:
          from: $.relationship-type.connects.destination.node
          to: $.relationship-type.connects.source.node
          port: $.destination.interfaces['port'].port # CLI populates 'source' and 'destination' for relationships
          security-mode: $.destination.domains['security'].security-mode # fictional domains example
      - filename: egress.yaml
        properties:
          from: $.relationship-type.connects.source.node
          to: $.relationship-type.connects.destination.node
  - unique-id: "consumer-load-balancer" # this doesn't exist, but it's an example
    templates: 
      - filename: ingress-external.yaml
        properties:
          to: $.relationship-type.connects.source.node

  - unique-id: "application-database"
    templates:
      - filename: ingress.yaml
        properties:
          from: $.relationship-type.connects.destination.node
          to: $.relationship-type.connects.source.node
          port: $.destination.interfaces['port'].port # CLI populates 'source' and 'destination' for relationships
          security-mode: $.destination.domains['security'].security-mode # fictional domains example
      - filename: egress.yaml
        properties:
          from: $.relationship-type.connects.source.node
          to: $.relationship-type.connects.destination.node